<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despedida de L√©o e S√¥nia - Corrida Especial</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #87CEEB, #1E90FF);
            text-align: center;
        }
        .qr-code-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin: 20px 0;
            
        }

        .qr-code-box {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 0 20px;
        }

        /* Remova o img src diretamente, o qrcode.js vai gerar o conte√∫do */
        .qr-code-box .qr-code-placeholder {
            width: 200px; /* Defina o tamanho do div que receber√° o QR Code */
            height: 200px;
            display: flex; /* Para centralizar o QR Code gerado */
            justify-content: center;
            align-items: center;
            margin: 0 auto; /* Centraliza o placeholder */
        }

        .qr-code-box p {
            color: black;
            font-weight: bold;
            margin-top: 10px;
        }

        .control-status {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            z-index: 20;
        }

        .control-indicator {
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
        }

        .control-indicator.active {
            background-color: rgba(0,255,0,0.7);
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            margin: 20px auto;
            border: 4px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: url('https://source.unsplash.com/random/800x600/?landscape') center/cover;
        }

        #road {
            position: absolute;
            width: 300px;
            height: 600px;
            background-color: #444;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #road-lines {
            position: absolute;
            width: 20px;
            height: 600px;
            left: 50%;
            transform: translateX(-50%);
        }

        .line {
            position: absolute;
            width: 10px;
            height: 50px;
            background-color: white;
            left: 50%;
            transform: translateX(-50%);
        }

        #car {
            position: absolute;
            width: 60px;
            height: 130px;
            background-color: red;
            border-radius: 10px;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            transition: left 0.2s;
            background: url('img/carro.png') center/cover; /* Imagem de carro gen√©rica - substitua pela imagem real */

        }

        .obstacle {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #333;
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: url('https://source.unsplash.com/random/60x60/?obstacle') center/cover;
        }

        #cat {
            position: absolute;
            width: 40px;
            height: 40px;
            background: url('img/mia.png') center/cover; /* Imagem de gato gen√©rica - substitua pela imagem real */
            z-index: 15;
            display: none;
        }

        #cat-dialog {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            font-size: 16px;
            z-index: 15;
            display: none;
        }

        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 20;
        }

        #level {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 20;
        }

        #start-screen, #game-over-screen, #level-complete, #game-complete, #cat-event, #qr-code-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        #game-over-screen, #level-complete, #game-complete, #cat-event, #start-screen {
            display: none; /* Hide start-screen initially to show QR screen */
        }

        h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 5px #388E3C;
            transition: all 0.3s;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(2px);
            box-shadow: 0 3px #388E3C;
        }

        .video-container {
            width: 80%;
            height: 60%;
            background: #000;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            max-width: 100%;
            max-height: 100%;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            z-index: 15;
        }

        .joy-bubble {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            font-size: 16px;
            z-index: 15;
            animation: fadeOut 2s forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .roadside-image {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 3;
            background-size: cover;
            background-position: center;
        }

        .roadside-image.left {
            left: 50px;
        }

        .roadside-image.right {
            right: 50px;
        }

        .sound-icon {
            position: absolute;
            top: 80px;
            right: 20px;
            font-size: 24px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 20;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="control-status">
            <div id="left-control-indicator" class="control-indicator">‚¨ÖÔ∏è Desconectado</div>
            <div id="right-control-indicator" class="control-indicator">‚û°Ô∏è Desconectado</div>
        </div>

        <div id="qr-code-screen">
            <h1>Controles Compartilhados</h1>
            <p>Escaneie os QR Codes abaixo para dividir os controles do jogo:</p>

            <div class="qr-code-container">
                <div class="qr-code-box">
                    <div id="left-qr" class="qr-code-placeholder"></div>
                    <p>Controle Esquerdo</p>
                </div>

                <div class="qr-code-box">
                    <div id="right-qr" class="qr-code-placeholder"></div>
                    <p>Controle Direito</p>
                </div>
            </div>

            <p>Ap√≥s escanear, o jogo come√ßar√° automaticamente quando ambos os controles estiverem conectados.</p>
            <button id="skip-qr-button">Pular e Jogar Sozinho</button>
        </div>

        <div id="road"></div>
        <div id="road-lines"></div>
        <div id="car"></div>
        <div id="cat"></div>
        <div id="cat-dialog">Miau!</div>
        <div id="score">Pontos: 0</div>
        <div id="level">Fase: 1</div>
        <div id="sound-toggle" class="sound-icon">üîä</div>

        <div id="start-screen">
            <h1>Despedida de L√©o e S√¥nia</h1>
            <p>Ajude nossos amigos a concluir sua √∫ltima viagem juntos!</p>
            <p>Use as setas ‚Üê ‚Üí para mover o carro e evitar obst√°culos</p>
            <button id="start-button">Iniciar Jogo</button>
        </div>

        <div id="game-over-screen">
            <h1>Fim de Jogo</h1>
            <p>N√£o desista! L√©o e S√¥nia contam com voc√™!</p>
            <button id="restart-button">Tentar Novamente</button>
        </div>

        <div id="level-complete">
            <h1>Fase Conclu√≠da!</h1>
            <div class="video-container">
                <video id="level-video" width="100%" height="100%" controls preload="auto">
                    <source src="videos/fase1.mp4" type="video/mp4">
                    Seu navegador n√£o suporta o elemento de v√≠deo.
                </video>
            </div>
            <p>Eles est√£o se divertindo muito nessa viagem!</p>
            <button id="next-level-button" style="display:none;">Pr√≥xima Fase</button>
        </div>

        <div id="cat-event">
            <h1>Olha quem est√° aqui!</h1>
            <p>Mia quer se juntar √† viagem!</p>            
            <button id="continue-with-cat-button">Continuar Viagem</button>
        </div>

        <div id="game-complete">
            <h1>Parab√©ns!</h1>
            <p>Voc√™ completou todas as fases da viagem de despedida!</p>
            <div class="video-container">
                <video id="final-video" width="100%" height="100%" controls preload="auto">
                    <source src="videos/fase3.mp4" type="video/mp4">
                    Seu navegador n√£o suporta o elemento de v√≠deo.
                </video>
            </div>
            <p>Desejamos a L√©o e S√¥nia muita felicidade em sua nova jornada!</p>
            <button id="play-again-button" style="display:none;">Jogar Novamente</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script>
        // Elementos do jogo
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const levelCompleteScreen = document.getElementById('level-complete');
        const gameCompleteScreen = document.getElementById('game-complete');
        const catEventScreen = document.getElementById('cat-event');
        const car = document.getElementById('car');
        const cat = document.getElementById('cat');
        const catDialog = document.getElementById('cat-dialog');
        const road = document.getElementById('road');
        const roadLines = document.getElementById('road-lines');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const soundToggle = document.getElementById('sound-toggle');

        // Elementos de v√≠deo
        const levelVideo = document.getElementById('level-video');
    

        // Bot√µes
        const nextLevelButton = document.getElementById('next-level-button');
        const continueWithCatButton = document.getElementById('continue-with-cat-button');
        const playAgainButton = document.getElementById('play-again-button');

        document.getElementById('start-button').addEventListener('click', startGame);
        document.getElementById('restart-button').addEventListener('click', restartGame);
        nextLevelButton.addEventListener('click', nextLevel);
        playAgainButton.addEventListener('click', restartGame);
        continueWithCatButton.addEventListener('click', continueWithCat);

        // Vari√°veis do jogo
        let gameRunning = false;
        let score = 0;
        let level = 1;
        let speed = 3;
        let obstacles = [];
        let lines = [];
        let roadsideImages = [];
        let animationFrame;
        let obstacleInterval;
        let joyBubbleInterval;
        let roadsideImageInterval;
        let soundEnabled = true;
        let obstaclePattern = 0; // Padr√£o atual de obst√°culos
        let catJoined = false;   // Se a gata j√° se juntou ao carro
        let catEventTriggered = false; // Se o evento da gata j√° foi acionado

        // Sons do jogo
        const sounds = {
            background: new Audio('music/son-carro.mp3'),
            collision: new Audio('music/collision.mp3'),
            levelComplete: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
            gameComplete: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'),
            friendVoices: [
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-crowd-talking-and-laughing-374.mp3'),
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-group-cheer-and-applause-518.mp3'),
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-small-crowd-ovation-437.mp3')
            ],
            catMeow: new Audio('music/cat-mia.mp3'),
            callCat: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-girl-calling-a-cat-with-a-sweet-voice-411.mp3')
        };

        // Configurar sons
        sounds.background.loop = true;
        sounds.background.volume = 0.3;
        sounds.catMeow.volume = 0.7;
        sounds.callCat.volume = 0.7;

        // Toggle de som
        soundToggle.addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';

            if (soundEnabled) {
                if (gameRunning) sounds.background.play();
            } else {
                sounds.background.pause();
                sounds.friendVoices.forEach(sound => sound.pause());
                sounds.catMeow.pause();
                sounds.callCat.pause();
            }
        });

        // Fun√ß√£o para tocar som
        function playSound(sound) {
            if (soundEnabled) {
                sound.currentTime = 0;
                sound.play();
            }
        }

        // Fun√ß√£o para tocar voz de amigo aleat√≥ria
        function playRandomFriendVoice() {
            if (!gameRunning || !soundEnabled) return;

            const randomVoice = sounds.friendVoices[Math.floor(Math.random() * sounds.friendVoices.length)];
            randomVoice.volume = 0.4;
            randomVoice.play();

            // Parar ap√≥s alguns segundos
            setTimeout(() => {
                randomVoice.pause();
                randomVoice.currentTime = 0;
            }, 3000);
        }

        // Configura√ß√µes de n√≠vel
        const levelSettings = {
            1: { speed: 3, obstacleFrequency: 2000, pointsToComplete: 100, patterns: 3 },
            2: { speed: 4, obstacleFrequency: 1800, pointsToComplete: 150, patterns: 4 },
            3: { speed: 5, obstacleFrequency: 1500, pointsToComplete: 200, patterns: 5 }
        };

        // URLs dos v√≠deos (substitua com seus caminhos de v√≠deo reais)
        const videoUrls = {
            level1: 'videos/fase1.mp4', // Exemplo: videos/level1.mp4
            level2: 'videos/fase2.mp4',
            level3: 'videos/fase3.mp4',
        };

        // Textos de alegria para os bal√µes
        const joyTexts = [
            "Uhuuu!",
            "Que viagem!",
            "Vamos l√°!",
            "Divertido!",
            "Que aventura!",
            "Demais!!",
            "Saudades!",
            "Lembran√ßas!"
        ];

        // Imagens para as margens da estrada
        const roadsideImageUrls = [
            'img/IMG-20250519-WA0075.jpg',
            'https://photos.google.com/photo/AF1QipOWO0Qvsnre_Cdx7JTt6SDaeIn-96rjWAkm4cdj',
            'https://photos.google.com/photo/AF1QipNTqwxKcIHLggGjXW2Ii5iI_x5UM2UavkwhBKPo',
            'https://photos.google.com/photo/AF1QipOJk77TvZCo3dCyJxSQ0QtSHnoa0pp3G1ZDxId5',
            'https://photos.google.com/photo/AF1QipPmBNoiTiYe1O42lacEmGNhSI6ntJU2CbbBc-qS'
        ];

        // Criar linhas da estrada
        function createRoadLines() {
            roadLines.innerHTML = '';
            const lineCount = 12;
            lines = [];

            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.className = 'line';
                line.style.top = (i * 100) - 50 + 'px';
                roadLines.appendChild(line);
                lines.push({ element: line, y: (i * 100) - 50 });
            }
        }

        // Movimento das linhas da estrada
        function moveRoadLines() {
            for (let i = 0; i < lines.length; i++) {
                lines[i].y += speed;
                lines[i].element.style.top = lines[i].y + 'px';

                if (lines[i].y > 600) {
                    lines[i].y = -50;
                    lines[i].element.style.top = lines[i].y + 'px';
                }
            }
        }

        // Criar imagens nas margens da estrada
        function createRoadsideImage() {
            if (!gameRunning) return;

            const image = document.createElement('div');
            image.className = 'roadside-image';

            // Escolher lado aleat√≥rio (esquerda ou direita)
            const side = Math.random() > 0.5 ? 'left' : 'right';
            image.classList.add(side);

            // Escolher imagem aleat√≥ria
            const randomImageUrl = roadsideImageUrls[Math.floor(Math.random() * roadsideImageUrls.length)];
            image.style.backgroundImage = `url(${randomImageUrl})`;

            // Posicionar fora da tela (acima)
            image.style.top = '-100px';

            document.getElementById('game-container').appendChild(image);

            roadsideImages.push({
                element: image,
                y: -100,
                side: side
            });

            // Tocar som de amigo falando ocasionalmente
            if (Math.random() > 0.7) {
                playRandomFriendVoice();
            }
        }

        // Movimento das imagens nas margens
        function moveRoadsideImages() {
            for (let i = 0; i < roadsideImages.length; i++) {
                roadsideImages[i].y += speed;
                roadsideImages[i].element.style.top = roadsideImages[i].y + 'px';

                // Remover imagem quando sair da tela
                if (roadsideImages[i].y > 600) {
                    roadsideImages[i].element.remove();
                    roadsideImages.splice(i, 1);
                    i--;
                }
            }
        }

        // Evento da gata Mia
        function triggerCatEvent() {
            if (catEventTriggered) return;

            catEventTriggered = true;
            gameRunning = false;

            // Pausar o jogo
            cancelAnimationFrame(animationFrame);
            clearInterval(obstacleInterval);
            clearInterval(joyBubbleInterval);
            clearInterval(roadsideImageInterval);

            // Pausar m√∫sica de fundo
            sounds.background.pause();

            // Tocar som de chamar a gata
            playSound(sounds.callCat);

            // Posicionar a gata na estrada
            const roadRect = road.getBoundingClientRect();
            const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();
            const roadLeft = roadRect.left - gameContainerRect.left;
            const roadWidth = roadRect.width;

            cat.style.display = 'block';
            cat.style.left = (roadLeft + roadWidth * 0.7) + 'px';
            cat.style.top = '100px';

            // Mostrar di√°logo da gata
            catDialog.style.display = 'block';
            catDialog.style.left = (parseInt(cat.style.left) + 40) + 'px';
            catDialog.style.top = (parseInt(cat.style.top) - 30) + 'px';

            // Tocar miado da gata
            setTimeout(() => {
                playSound(sounds.catMeow);
            }, 1000);

            // Mostrar tela do evento da gata ap√≥s um curto atraso
            setTimeout(() => {
                catDialog.style.display = 'none';
                cat.style.display = 'none';
                catEventScreen.style.display = 'flex';

                // Configurar e reproduzir v√≠deo da gata
               
                continueWithCatButton.style.display = 'block'; // Esconder bot√£o

                

            }, 3000);
        }

        // Continuar jogo ap√≥s evento da gata
        function continueWithCat() {
            catEventScreen.style.display = 'none';
            // Pausar e redefinir o v√≠deo da gata
           
            continueWithCatButton.style.display = 'none'; // Esconder novamente

            catJoined = true;

            // Adicionar a gata ao carro
            cat.style.display = 'block';
            const carRect = car.getBoundingClientRect();
            const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();
            cat.style.left = (carRect.left - gameContainerRect.left + 20) + 'px';
            cat.style.top = (carRect.top - gameContainerRect.top + 30) + 'px';

            // Reiniciar m√∫sica de fundo
            if (soundEnabled) {
                sounds.background.currentTime = 0;
                sounds.background.play();
            }

            // Reiniciar jogo
            gameRunning = true;
            gameLoop();
            obstacleInterval = setInterval(createObstacle, levelSettings[level].obstacleFrequency);
            joyBubbleInterval = setInterval(createJoyBubble, 3000);
            roadsideImageInterval = setInterval(createRoadsideImage, 4000);
        }

        // Padr√µes de obst√°culos para cada fase
        const obstaclePatterns = {
            // Fase 1: Padr√µes simples
            1: [
                // Padr√£o 1: Obst√°culo √† esquerda
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.25;
                },
                // Padr√£o 2: Obst√°culo √† direita
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.75;
                },
                // Padr√£o 3: Obst√°culo no centro
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.5;
                }
            ],
            // Fase 2: Padr√µes mais complexos
            2: [
                // Padr√£o 1: Obst√°culo √† esquerda
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.25;
                },
                // Padr√£o 2: Obst√°culo √† direita
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.75;
                },
                // Padr√£o 4: Obst√°culo no centro
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.5;
                }
            ],
            // Fase 3: Padr√µes mais dif√≠ceis
            3: [
                // Padr√£o 1: Obst√°culo √† esquerda
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.25;
                },
                // Padr√£o 2: Obst√°culo √† direita
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.75;
                },
                // Padr√£o 4: Obst√°culo no centro
                function(roadLeft, roadWidth) {
                    return roadLeft + roadWidth * 0.5;
                }
            ]
        };

        // Fun√ß√£o para criar obst√°culo em posi√ß√£o espec√≠fica
        function createObstacleAt(x, y = -60) {
            if (!gameRunning) return;

            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';

            obstacle.style.left = x + 'px';
            obstacle.style.top = y + 'px';
            document.getElementById('game-container').appendChild(obstacle);

            obstacles.push({
                element: obstacle,
                x: x,
                y: y
            });
        }

        // Criar obst√°culo com padr√£o
        function createObstacle() {
            if (!gameRunning) return;

            // Verificar se √© hora de acionar o evento da gata (na fase 2, ap√≥s 50 pontos)
            if (level === 2 && score >= 50 && !catEventTriggered) {
                triggerCatEvent();
                return;
            }

            // Obter dimens√µes da estrada
            const roadRect = road.getBoundingClientRect();
            const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();
            const roadLeft = roadRect.left - gameContainerRect.left;
            const roadWidth = roadRect.width;

            // Selecionar padr√£o de obst√°culos para o n√≠vel atual
            const patterns = obstaclePatterns[level];
            const patternFunction = patterns[obstaclePattern];

            // Avan√ßar para o pr√≥ximo padr√£o
            obstaclePattern = (obstaclePattern + 1) % patterns.length;

            // Criar obst√°culo(s) de acordo com o padr√£o
            const x = patternFunction(roadLeft, roadWidth);

            // Se a fun√ß√£o retornar uma posi√ß√£o, criar o obst√°culo principal
            if (x !== null) {
                createObstacleAt(x);
            }
        }

        // Movimento dos obst√°culos
        function moveObstacles() {
            for (let i = 0; i < obstacles.length; i++) {
                obstacles[i].y += speed;
                obstacles[i].element.style.top = obstacles[i].y + 'px';

                // Remover obst√°culo quando sair da tela
                if (obstacles[i].y > 600) {
                    obstacles[i].element.remove();
                    obstacles.splice(i, 1);
                    i--;
                    score += 10;
                    scoreElement.textContent = 'Pontos: ' + score;

                    // Verificar se completou o n√≠vel
                    if (score >= levelSettings[level].pointsToComplete) {
                        completeLevel();
                    }
                }
            }
        }

        // Verificar colis√µes
        function checkCollisions() {
            const carRect = car.getBoundingClientRect();
            const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();

            // Ajustar coordenadas do carro em rela√ß√£o ao container
            const carLeft = carRect.left - gameContainerRect.left;
            const carRight = carRect.right - gameContainerRect.left;
            const carTop = carRect.top - gameContainerRect.top;
            const carBottom = carRect.bottom - gameContainerRect.top;

            // Colis√£o com borda da estrada
            const roadRect = road.getBoundingClientRect();
            const roadLeft = roadRect.left - gameContainerRect.left;
            const roadRight = roadRect.right - gameContainerRect.left;

            if (carLeft < roadLeft || carRight > roadRight) {
                // Game over ao sair da estrada
                gameOver();
                return;
            }
            if (carLeft < roadLeft || carRight > roadRight) {
                // Game over ao sair da estrada
                gameOver();
                return;
            }

            // Colis√£o com obst√°culos
            for (let i = 0; i < obstacles.length; i++) {
                const obstacleRect = obstacles[i].element.getBoundingClientRect();
                const obstacleLeft = obstacleRect.left - gameContainerRect.left;
                const obstacleRight = obstacleRect.right - gameContainerRect.left;
                const obstacleTop = obstacleRect.top - gameContainerRect.top;
                const obstacleBottom = obstacleRect.bottom - gameContainerRect.top;

                if (
                    carRight > obstacleLeft &&
                    carLeft < obstacleRight &&
                    carBottom > obstacleTop &&
                    carTop < obstacleBottom
                ) {
                    // Game over ao colidir com obst√°culo
                    gameOver();
                    return;
                }
            }

            // Atualizar posi√ß√£o da gata se ela estiver no carro
            if (catJoined) {
                const carRect = car.getBoundingClientRect();
                const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();
                cat.style.left = (carRect.left - gameContainerRect.left + 20) + 'px';
                cat.style.top = (carRect.top - gameContainerRect.top + 30) + 'px';

                // Ocasionalmente fazer a gata miar
                if (Math.random() < 0.002) {
                    playSound(sounds.catMeow);

                    // Mostrar di√°logo da gata
                    catDialog.style.display = 'block';
                    catDialog.style.left = (parseInt(cat.style.left) + 40) + 'px';
                    catDialog.style.top = (parseInt(cat.style.top) - 30) + 'px';

                    // Esconder di√°logo ap√≥s alguns segundos
                    setTimeout(() => {
                        catDialog.style.display = 'none';
                    }, 2000);
                }
            }
        }

        // Game over
        function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(animationFrame);
            clearInterval(obstacleInterval);
            clearInterval(joyBubbleInterval);
            clearInterval(roadsideImageInterval);

            // Tocar som de colis√£o
            sounds.background.pause();
            playSound(sounds.collision);

            // Esconder a gata e seu di√°logo
            cat.style.display = 'none';
            catDialog.style.display = 'none';

            // Mostrar tela de game over
            gameOverScreen.style.display = 'flex';
        }

        // Controles do carro
        let carPosition = 400; // Posi√ß√£o inicial
        let keysPressed = {};

        // Fun√ß√µes para controle de teclado (ainda √∫teis para solo ou debug)
        window.addEventListener('keydown', function(e) {
            keysPressed[e.key] = true;
        });

        window.addEventListener('keyup', function(e) {
            keysPressed[e.key] = false;
        });

        // Criar bal√µes de alegria
        function createJoyBubble() {
            if (!gameRunning) return;

            const bubble = document.createElement('div');
            bubble.className = 'joy-bubble';

            // Texto aleat√≥rio de alegria
            const randomText = joyTexts[Math.floor(Math.random() * joyTexts.length)];
            bubble.textContent = randomText;

            // Posicionar sobre o carro
            const carRect = car.getBoundingClientRect();
            const gameContainerRect = document.getElementById('game-container').getBoundingClientRect();

            bubble.style.left = (carRect.left - gameContainerRect.left + Math.random() * 40) + 'px';
            bubble.style.top = (carRect.top - gameContainerRect.top - 30) + 'px';

            document.getElementById('game-container').appendChild(bubble);

            // Remover ap√≥s a anima√ß√£o
            setTimeout(() => {
                bubble.remove();
            }, 2000);
        }

        // Criar confetes (efeito de celebra√ß√£o)
        function createConfetti() {
            const gameContainer = document.getElementById('game-container');
            const containerRect = gameContainer.getBoundingClientRect();

            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    if ((!document.getElementById('level-complete').style.display ||
                        document.getElementById('level-complete').style.display === 'none') &&
                        (!document.getElementById('game-complete').style.display ||
                        document.getElementById('game-complete').style.display === 'none')) return;

                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';

                    // Cores aleat√≥rias
                    const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

                    // Tamanho aleat√≥rio
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';

                    // Posi√ß√£o aleat√≥ria
                    confetti.style.left = Math.random() * containerRect.width + 'px';
                    confetti.style.top = -20 + 'px';

                    gameContainer.appendChild(confetti);

                    // Anima√ß√£o de queda
                    let posY = -20;
                    let posX = parseFloat(confetti.style.left);
                    const speedY = Math.random() * 2 + 1;
                    const speedX = Math.random() * 2 - 1;

                    const fall = setInterval(() => {
                        if (posY > containerRect.height) {
                            clearInterval(fall);
                            confetti.remove();
                            return;
                        }

                        posY += speedY;
                        posX += speedX;
                        confetti.style.top = posY + 'px';
                        confetti.style.left = posX + 'px';

                        // Rota√ß√£o
                        confetti.style.transform = `rotate(${posY * 2}deg)`;
                    }, 20);
                }, i * 20);
            }
        }

        // Loop principal do jogo
        function gameLoop() {
            if (!gameRunning) return;

            moveCar();
            moveRoadLines();
            moveObstacles();
            moveRoadsideImages();
            checkCollisions();

            animationFrame = requestAnimationFrame(gameLoop);
        }

        // Iniciar jogo
        function startGame() {
            startScreen.style.display = 'none';
            gameRunning = true;
            score = 0;
            level = 1;
            speed = levelSettings[level].speed;
            obstaclePattern = 0;
            catJoined = false;
            catEventTriggered = false;
            scoreElement.textContent = 'Pontos: ' + score;
            levelElement.textContent = 'Fase: ' + level;

            // Esconder a gata e seu di√°logo
            cat.style.display = 'none';
            catDialog.style.display = 'none';

            // Posicionar carro
            const gameContainer = document.getElementById('game-container');
            const roadRect = road.getBoundingClientRect();
            const gameContainerRect = gameContainer.getBoundingClientRect();
            carPosition = (roadRect.left - gameContainerRect.left) + (roadRect.width / 2) - 40;
            car.style.left = carPosition + 'px';

            // Limpar obst√°culos anteriores
            obstacles.forEach(obstacle => obstacle.element.remove());
            obstacles = [];

            // Limpar imagens nas margens
            roadsideImages.forEach(image => image.element.remove());
            roadsideImages = [];

            // Criar linhas
            createRoadLines();

            // Iniciar m√∫sica de fundo
            if (soundEnabled) {
                sounds.background.currentTime = 0;
                sounds.background.play();
            }

            // Iniciar loops
            gameLoop();
            obstacleInterval = setInterval(createObstacle, levelSettings[level].obstacleFrequency);
            joyBubbleInterval = setInterval(createJoyBubble, 3000);
            roadsideImageInterval = setInterval(createRoadsideImage, 4000);
        }

        // Reiniciar jogo
        function restartGame() {
            gameOverScreen.style.display = 'none';
            gameCompleteScreen.style.display = 'none';

            // Pausar e redefinir v√≠deos
            levelVideo.pause();
            levelVideo.currentTime = 0;
           

            // Esconder bot√µes novamente
            nextLevelButton.style.display = 'none';
            continueWithCatButton.style.display = 'none';
            playAgainButton.style.display = 'none';

            startGame();
        }

        // Completar n√≠vel
        function completeLevel() {
            gameRunning = false;
            cancelAnimationFrame(animationFrame);
            clearInterval(obstacleInterval);
            clearInterval(joyBubbleInterval);
            clearInterval(roadsideImageInterval);

            // Parar m√∫sica de fundo e tocar som de conclus√£o
            sounds.background.pause();
            playSound(sounds.levelComplete);

            // completedLevelSpan is not defined in this scope, removing
            // completedLevelSpan.textContent = level;

            if (level < 3) {
                levelCompleteScreen.style.display = 'flex';
                createConfetti();

                // Configurar e reproduzir v√≠deo da fase
                levelVideo.src = videoUrls[`level${level}`];
                levelVideo.load();
                levelVideo.play();
                nextLevelButton.style.display = 'none'; // Esconder bot√£o

                levelVideo.onended = () => {
                    nextLevelButton.style.display = 'block'; // Mostrar bot√£o ap√≥s o v√≠deo
                };

            } else {
                gameCompleteScreen.style.display = 'flex';
                playSound(sounds.gameComplete);
                createConfetti();

                
                playAgainButton.style.display = 'block'; // Esconder bot√£o

                finalVideo.onended = () => {
                    playAgainButton.style.display = 'block'; // Mostrar bot√£o ap√≥s o v√≠deo
                };
            }
        }

        // Pr√≥ximo n√≠vel
        function nextLevel() {
            levelCompleteScreen.style.display = 'none';
            // Pausar e redefinir o v√≠deo para o pr√≥ximo uso
            levelVideo.pause();
            levelVideo.currentTime = 0;
            nextLevelButton.style.display = 'none'; // Esconder novamente

            level++;
            levelElement.textContent = 'Fase: ' + level;
            speed = levelSettings[level].speed;
            score = 0;
            obstaclePattern = 0;
            scoreElement.textContent = 'Pontos: ' + score;

            // Limpar obst√°culos anteriores
            obstacles.forEach(obstacle => obstacle.element.remove());
            obstacles = [];

            // Limpar imagens nas margens
            roadsideImages.forEach(image => image.element.remove());
            roadsideImages = [];

            // Reiniciar m√∫sica de fundo
            if (soundEnabled) {
                sounds.background.currentTime = 0;
                sounds.background.play();
            }

            // Reiniciar jogo com novas configura√ß√µes
            gameRunning = true;
            gameLoop();
            obstacleInterval = setInterval(createObstacle, levelSettings[level].obstacleFrequency);
            joyBubbleInterval = setInterval(createJoyBubble, 3000);
            roadsideImageInterval = setInterval(createRoadsideImage, 4000);
        }

        // Configura√ß√£o inicial
        createRoadLines();

        // --- INTEGRA√á√ÉO COM CONTROLES REMOTOS VIA SOCKET.IO ---

        // Elementos dos QR codes e controles
        const qrCodeScreen = document.getElementById('qr-code-screen');
        // Alterado para divs que qrcode.js vai preencher
        const leftQRDiv = document.getElementById('left-qr');
        const rightQRDiv = document.getElementById('right-qr');
        const leftControlIndicator = document.getElementById('left-control-indicator');
        const rightControlIndicator = document.getElementById('right-control-indicator');

        // Bot√£o para pular QR
        document.getElementById('skip-qr-button').addEventListener('click', skipQRAndPlaySolo);

        // Esconder a tela inicial e mostrar a tela de QR code
        startScreen.style.display = 'none';
        qrCodeScreen.style.display = 'flex'; // Certifica que a tela de QR code √© mostrada primeiro

        // Vari√°veis de controle
        let leftControlConnected = false;
        let rightControlConnected = false;
        let controlMode = 'waiting'; // 'waiting', 'shared', 'solo'
        let leftControlActive = false;
        let rightControlActive = false;
        let socket;

        // Conectar ao servidor WebSocket
        function connectWebSocket() {
            socket = io();

            // Quando conectado ao servidor
            socket.on('connect', () => {
                console.log('Conectado ao servidor WebSocket');
            });

            // Quando um controle se conecta
            socket.on('control-connected', (data) => {
                if (data.type === 'left') {
                    leftControlConnected = true;
                    leftControlIndicator.textContent = "‚¨ÖÔ∏è Conectado";
                    leftControlIndicator.classList.add('active');
                } else if (data.type === 'right') {
                    rightControlConnected = true;
                    rightControlIndicator.textContent = "‚û°Ô∏è Conectado";
                    rightControlIndicator.classList.add('active');
                }

                checkBothConnected();
            });

            // Quando um controle se desconecta
            socket.on('control-disconnected', (data) => {
                if (data.type === 'left') {
                    leftControlConnected = false;
                    leftControlIndicator.textContent = "‚¨ÖÔ∏è Desconectado";
                    leftControlIndicator.classList.remove('active');
                    leftControlActive = false; // Garante que o controle √© desativado
                } else if (data.type === 'right') {
                    rightControlConnected = false;
                    rightControlIndicator.textContent = "‚û°Ô∏è Desconectado";
                    rightControlIndicator.classList.remove('active');
                    rightControlActive = false; // Garante que o controle √© desativado
                }
            });

            // Quando recebe um comando de controle
            socket.on('game-control', (data) => {
                if (data.action === 'left') {
                    leftControlActive = data.active;
                } else if (data.action === 'right') {
                    rightControlActive = data.active;
                }
            });

            // Quando o servidor desconecta
            socket.on('disconnect', () => {
                console.log('Desconectado do servidor WebSocket');
                leftControlConnected = false;
                rightControlConnected = false;
                leftControlIndicator.textContent = "‚¨ÖÔ∏è Desconectado";
                leftControlIndicator.classList.remove('active');
                rightControlIndicator.textContent = "‚û°Ô∏è Desconectado";
                rightControlIndicator.classList.remove('active');
            });
        }

        // Gerar QR codes
        function generateQRCodes() {
            // A URL base para os controles ser√° o endere√ßo do seu servidor
            const baseUrl = window.location.origin; // Ex: http://localhost:3000

            const leftControlUrl = `${baseUrl}/left-control.html`;
            const rightControlUrl = `${baseUrl}/right-control.html`;

            // Limpar elementos anteriores
            leftQRDiv.innerHTML = '';
            rightQRDiv.innerHTML = '';

            // Criar novos QR codes
            new QRCode(leftQRDiv, {
                text: leftControlUrl,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            new QRCode(rightQRDiv, {
                text: rightControlUrl,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Conectar ao WebSocket para receber os controles
            connectWebSocket();
        }

        // Verificar se ambos os controles est√£o conectados
        function checkBothConnected() {
            if (leftControlConnected && rightControlConnected && controlMode === 'waiting') {
                controlMode = 'shared';
                // Iniciar o jogo automaticamente ap√≥s um breve atraso
                setTimeout(() => {
                    qrCodeScreen.style.display = 'none';
                    startScreen.style.display = 'flex';
                }, 1500);
            }
        }

        // Pular QR e jogar sozinho
        function skipQRAndPlaySolo() {
            controlMode = 'solo';
            qrCodeScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            // Se pular para solo, garanta que os indicadores de controle estejam 'desconectados'
            leftControlIndicator.textContent = "‚¨ÖÔ∏è Desconectado (Solo)";
            leftControlIndicator.classList.remove('active');
            rightControlIndicator.textContent = "‚û°Ô∏è Desconectado (Solo)";
            rightControlIndicator.classList.remove('active');
        }

        // Modificar a fun√ß√£o de controle do carro para suportar controles compartilhados
        function moveCar() {
            const moveSpeed = 5;

            if (controlMode === 'solo') {
                // Modo solo - um jogador controla ambas as dire√ß√µes com teclado
                if (keysPressed['ArrowLeft']) {
                    carPosition -= moveSpeed;
                }

                if (keysPressed['ArrowRight']) {
                    carPosition += moveSpeed;
                }
            } else if (controlMode === 'shared') {
                // Modo compartilhado - cada jogador controla uma dire√ß√£o via Socket.IO
                if (leftControlActive) {
                    carPosition -= moveSpeed;
                }

                if (rightControlActive) {
                    carPosition += moveSpeed;
                }
            }

            car.style.left = carPosition + 'px';
        }

        // Remove os ouvintes de teclado para 'a' e 'd' se o modo for 'shared' no in√≠cio do gameLoop,
        // mas mant√©m 'ArrowLeft' e 'ArrowRight' para o modo 'solo'.
        // Ou, pode-se simplesmente deixar o `moveCar` lidar com isso, o que j√° est√° acontecendo.
        // As seguintes linhas de keydown/keyup para 'a' e 'd' podem ser removidas se n√£o forem para teste.
        // Se voc√™ quiser que o teclado ainda funcione para a e d no modo solo, mantenha-os.
        // Como o `controlMode` j√° est√° sendo verificado em `moveCar`, estas n√£o s√£o estritamente necess√°rias para "simular",
        // elas apenas fazem o 'a' e 'd' funcionarem como os controles remotos no modo solo.
     
        window.addEventListener('keydown', function(e) {
            keysPressed[e.key] = true;
            if (e.key === 'a' && controlMode === 'solo') leftControlActive = true;
            if (e.key === 'd' && controlMode === 'solo') rightControlActive = true;
        });

        window.addEventListener('keyup', function(e) {
            keysPressed[e.key] = false;
            if (e.key === 'a') leftControlActive = false;
            if (e.key === 'd') rightControlActive = false;
        });
        

        // Iniciar gera√ß√£o de QR codes quando a p√°gina carregar
        window.addEventListener('load', function() {
            generateQRCodes();
        });
    </script>
</body>
</html>